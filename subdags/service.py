from airflow.models import DAG
from airflow.operators.dummy_operator import DummyOperator
from datetime import datetime, timedelta
from airflow.operators import PythonOperator
from airflow.hooks import RedisHook
from airflow.models import Variable
import logging
import itertools

default_args = {
    'owner': 'wireless',
    'depends_on_past': False,
    'start_date': datetime(2017, 03, 30,13,00),
    'email': ['vipulsharma144@gmail.com'],
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=1),
    'provide_context': True,
    # 'queue': 'bash_queue',
    # 'pool': 'backfill',
    # 'priority_weight': 10,
    # 'end_date': datetime(2016, 1, 1),
}

	
redis_hook_4 = RedisHook(redis_conn_id="redis_hook_4")

def service_etl(parent_dag_name, child_dag_name, start_date, schedule_interval):
	config = eval(Variable.get('system_config'))

	dag_subdag = DAG(
    		dag_id="%s.%s" % (parent_dag_name, child_dag_name),
    		schedule_interval=schedule_interval,
    		start_date=start_date,
  		)
	def get_from_socket(site_name, query):
		"""
		Function_name : get_from_socket (collect the query data from the socket)

		Args: site_name (poller on which monitoring data is to be collected)

		Kwargs: query (query for which data to be collectes from nagios.)

		Return : None

		raise
		     Exception: SyntaxError,socket error
	    	"""
		socket_path = "/omd/sites/%s/tmp/run/live" % site_name
		#s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
		machine = site_name[:-8]
		#socket_ip = _LIVESTATUS[machine]['host']
		#socket_port = _LIVESTATUS[machine][site_name]['port']
		#s.connect((socket_ip, socket_port))
		s.connect(socket_path)
		s.settimeout(60.0)
		s.send(query)
		s.shutdown(socket.SHUT_WR)
		output = ''
		wait_string= ''
		while True:
			try:
				out = s.recv(100000000)
		     	except socket.timeout,e:
				err=e.args[0]
				print 'socket timeout ..Exiting'
				if err == 'timed out':
					sys.exit(1) 
		
		     	if not len(out):
				break;
		     	output += out

		return output

	def extract_and_distribute(**kwargs):
		try:
			service_query = Variable.get('service_query') #to get LQL to extract service
			device_slot = Variable.get("device_slot_service") #the number of devices to be made into 1 slot  
		except ValueError:
			logging.info("Unable to fetch Service Query Failing Task")
			return 1

		task_site = kwargs.get('task_instance_key_str').split('_')[4:7]
		site_name = "_".join(task_site)
		#service_data = eval(get_from_socket(site_name, service_query))
		service_data =[[u'1', u'10.171.132.2', u'wimax_bs_temperature_acb', 0, 1492076618, 1491617765, 0, u'acb_temp=36;40;45;;'], [u'1', u'10.171.132.2', u'wimax_bs_uptime', 0, 1492076618, 1487139746, 0, u'uptime=454565;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp1_dl_util_bgp', 0, 1492076618, 1492063344, 0, u'pmp1_dl_util=2.14;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp1_frequency', 0, 1492076618, 1492075143, 0, u'frequency=3369;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp1_sector_id', 0, 1492076618, 1487139746, 0, u'pmp1_sector_id=00:0a:10:03:00:61;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp1_ul_util_bgp', 0, 1492076618, 1491971889, 0, u'pmp1_ul_util=1.03;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp2_dl_util_bgp', 0, 1492076618, 1492065410, 0, u'pmp2_dl_util=1.46;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp2_frequency', 0, 1492076618, 1492075143, 0, u'frequency=3319;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp2_sector_id', 0, 1492076618, 1487139746, 0, u'pmp2_sector_id=00:0a:10:03:00:63;;;;'], [u'1', u'10.171.132.2', u'wimax_pmp2_ul_util_bgp', 0, 1492076618, 1491993721, 0, u'pmp2_ul_util=0.39;;;;'], [u'100', u'10.191.34.3', u'wimax_bs_temperature_acb', 0, 1492076619, 1491650847, 0, u'acb_temp=36;40;45;;'], [u'100', u'10.191.34.3', u'wimax_bs_uptime', 0, 1492076620, 1487139747, 0, u'uptime=4315023;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp1_dl_util_bgp', 0, 1492076620, 1491981331, 0, u'pmp1_dl_util=0.46;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp1_frequency', 0, 1492076620, 1492075145, 0, u'frequency=3316;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp1_sector_id', 0, 1492076620, 1487139748, 0, u'pmp1_sector_id=00:0a:10:10:00:12;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp1_ul_util_bgp', 0, 1492076620, 1491977496, 0, u'pmp1_ul_util=0.19;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp2_dl_util_bgp', 0, 1492076620, 1492066295, 0, u'pmp2_dl_util=1.39;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp2_frequency', 0, 1492076620, 1492075145, 0, u'frequency=3319;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp2_sector_id', 0, 1492076620, 1487139749, 0, u'pmp2_sector_id=00:0a:10:10:00:14;;;;'], [u'100', u'10.191.34.3', u'wimax_pmp2_ul_util_bgp', 0, 1492076620, 1491991951, 0, u'pmp2_ul_util=0.09;;;;'], [u'1000', u'10.191.26.54', u'wimax_dl_cinr', 0, 1492076633, 1492075158, 1, u'dl_cinr=26;15;19;;'], [u'1000', u'10.191.26.54', u'wimax_dl_intrf', 0, 1492076634, 1492075159, 1, u'dl_intrf=Norm;;;;'], [u'1000', u'10.191.26.54', u'wimax_dl_rssi', 1, 1492076634, 1492075159, 1, u'dl_rssi=-65;-60;-90;;'], [u'1000', u'10.191.26.54', u'wimax_modulation_dl_fec', 0, 1492076635, 1492075160, 1, u'modulation_dl_fec=qam64-3/4;;;;'], [u'1000', u'10.191.26.54', u'wimax_modulation_ul_fec', 0, 1492076635, 1492075160, 1, u'modulation_ul_fec=qam16-3/4;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_dl_utilization', 0, 1492076636, 1487139753, 1, u'dl_utilization=0;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_frequency', 0, 1492076637, 1487139755, 1, u'frequency=3317.5;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_ip', 0, 1492076637, 1487139756, 1, u'ss_ip=10.191.26.54;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_mac', 0, 1492076637, 1487139757, 1, u'ss_mac=00:02:73:93:01:e1;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_sector_id', 0, 1492076640, 1492075164, 1, u'ss_sector_id=00:0a:10:43:00:51;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_session_uptime', 0, 1492076640, 1487139760, 1, u'session_uptime=14155;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_ul_utilization', 0, 1492076641, 1487139762, 1, u'ul_utilization=0;;;;'], [u'1000', u'10.191.26.54', u'wimax_ss_uptime', 0, 1492076641, 1487837861, 1, u'uptime=14116;;;;'], [u'1000', u'10.191.26.54', u'wimax_ul_cinr', 0, 1492076642, 1492075166, 1, u'ul_cinr=23;19;15;;'], [u'1000', u'10.191.26.54', u'wimax_ul_intrf', 0, 1492076642, 1492075166, 1, u'ul_intrf=Norm;;;;'], [u'1000', u'10.191.26.54', u'wimax_ul_rssi', 1, 1492076642, 1492075167, 1, u'ul_rssi=-74;-60;-90;;'], [u'1004', u'10.171.215.54', u'wimax_dl_cinr', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_dl_intrf', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_dl_rssi', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_modulation_dl_fec', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_modulation_ul_fec', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_dl_utilization', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_frequency', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_ip', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_mac', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_sector_id', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_session_uptime', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_ul_utilization', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ss_uptime', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ul_cinr', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ul_intrf', 0, 0, 0, 1, u''], [u'1004', u'10.171.215.54', u'wimax_ul_rssi', 0, 0, 0, 1, u''], [u'1006', u'10.191.161.38', u'wimax_dl_cinr', 0, 1492076618, 1492075143, 1, u'dl_cinr=27;15;19;;'], [u'1006', u'10.191.161.38', u'wimax_dl_intrf', 0, 1492076618, 1492075143, 1, u'dl_intrf=Norm;;;;'], [u'1006', u'10.191.161.38', u'wimax_dl_rssi', 0, 1492076619, 1492076619, 1, u'dl_rssi=-59;-60;-90;;'], [u'1006', u'10.191.161.38', u'wimax_modulation_dl_fec', 0, 1492076620, 1492075144, 1, u'modulation_dl_fec=qam64-3/4;;;;'], [u'1006', u'10.191.161.38', u'wimax_modulation_ul_fec', 0, 1492076621, 1492075144, 1, u'modulation_ul_fec=qam16-3/4;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_dl_utilization', 0, 1492076624, 1490867492, 1, u'dl_utilization=0.09;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_frequency', 0, 1492076625, 1490864543, 1, u'frequency=3319;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_ip', 0, 1492076625, 1490864543, 1, u'ss_ip=10.191.161.38;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_mac', 0, 1492076626, 1490864544, 1, u'ss_mac=00:02:73:91:ab:29;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_sector_id', 0, 1492076627, 1492075148, 1, u'ss_sector_id=00:0a:10:34:00:34;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_session_uptime', 0, 1492076628, 1490867495, 1, u'session_uptime=428993;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_ul_utilization', 0, 1492076628, 1490867495, 1, u'ul_utilization=0.05;;;;'], [u'1006', u'10.191.161.38', u'wimax_ss_uptime', 0, 1492076629, 1491542054, 1, u'uptime=429127;;;;'], [u'1006', u'10.191.161.38', u'wimax_ul_cinr', 1, 1492076629, 1492076629, 1, u'ul_cinr=19;19;15;;'], [u'1006', u'10.191.161.38', u'wimax_ul_intrf', 0, 1492076630, 1492075151, 1, u'ul_intrf=Norm;;;;'], [u'1006', u'10.191.161.38', u'wimax_ul_rssi', 1, 1492076630, 1492075151, 1, u'ul_rssi=-76;-60;-90;;'], [u'1010', u'10.166.136.58', u'wimax_dl_cinr', 0, 1492076638, 1492075163, 0, u'dl_cinr=20;15;19;;'], [u'1010', u'10.166.136.58', u'wimax_dl_intrf', 0, 1492076638, 1492075163, 0, u'dl_intrf=Norm;;;;'], [u'1010', u'10.166.136.58', u'wimax_dl_rssi', 1, 1492076638, 1492075163, 0, u'dl_rssi=-72;-60;-90;;'], [u'1010', u'10.166.136.58', u'wimax_modulation_dl_fec', 0, 1492076639, 1492075164, 0, u'modulation_dl_fec=qam16-3/4;;;;'], [u'1010', u'10.166.136.58', u'wimax_modulation_ul_fec', 0, 1492076639, 1492075164, 0, u'modulation_ul_fec=qam16-1/2;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_dl_utilization', 0, 1492076639, 1487139749, 0, u'dl_utilization=0;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_frequency', 0, 1492076640, 1487139750, 0, u'frequency=3319;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_ip', 0, 1492076640, 1487139750, 0, u'ss_ip=10.166.136.58;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_mac', 0, 1492076640, 1487139751, 0, u'ss_mac=00:02:73:91:91:74;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_sector_id', 0, 1492076641, 1492075167, 0, u'ss_sector_id=00:0b:10:05:40:82;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_session_uptime', 0, 1492076642, 1487139753, 0, u'session_uptime=22741;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_ul_utilization', 0, 1492076642, 1487139753, 0, u'ul_utilization=0;;;;'], [u'1010', u'10.166.136.58', u'wimax_ss_uptime', 0, 1492076642, 1490938933, 0, u'uptime=23151;;;;'], [u'1010', u'10.166.136.58', u'wimax_ul_cinr', 0, 1492076643, 1492075169, 0, u'ul_cinr=22;19;15;;'], [u'1010', u'10.166.136.58', u'wimax_ul_intrf', 0, 1492076643, 1492075169, 0, u'ul_intrf=Norm;;;;'], [u'1010', u'10.166.136.58', u'wimax_ul_rssi', 1, 1492076643, 1492075169, 0, u'ul_rssi=-77;-60;-90;;'], [u'1012', u'10.191.26.20', u'wimax_dl_cinr', 0, 1492076625, 1492075150, 0, u'dl_cinr=30;15;19;;'], [u'1012', u'10.191.26.20', u'wimax_dl_intrf', 0, 1492076625, 1492075150, 0, u'dl_intrf=Norm;;;;'], [u'1012', u'10.191.26.20', u'wimax_dl_rssi', 1, 1492076626, 1492075150, 0, u'dl_rssi=-61;-60;-90;;'], [u'1012', u'10.191.26.20', u'wimax_modulation_dl_fec', 0, 1492076626, 1492075151, 0, u'modulation_dl_fec=qam64-3/4;;;;'], [u'1012', u'10.191.26.20', u'wimax_modulation_ul_fec', 0, 1492076626, 1492075151, 0, u'modulation_ul_fec=qam64-2/3;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_dl_utilization', 0, 1492076627, 1487139749, 0, u'dl_utilization=0;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_frequency', 0, 1492076627, 1487139750, 0, u'frequency=3366;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_ip', 0, 1492076627, 1487139751, 0, u'ss_ip=10.191.26.20;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_mac', 0, 1492076628, 1487139752, 0, u'ss_mac=00:02:73:92:fe:f0;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_sector_id', 0, 1492076629, 1492075155, 0, u'ss_sector_id=00:0a:10:43:00:52;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_session_uptime', 0, 1492076629, 1487139754, 0, u'session_uptime=3618241;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_ul_utilization', 0, 1492076630, 1487139755, 0, u'ul_utilization=0;;;;'], [u'1012', u'10.191.26.20', u'wimax_ss_uptime', 0, 1492076630, 1492071910, 0, u'uptime=9234776;;;;'], [u'1012', u'10.191.26.20', u'wimax_ul_cinr', 0, 1492076630, 1492075156, 0, u'ul_cinr=24;19;15;;'], [u'1012', u'10.191.26.20', u'wimax_ul_intrf', 0, 1492076631, 1492075158, 0, u'ul_intrf=Norm;;;;'], [u'1012', u'10.191.26.20', u'wimax_ul_rssi', 1, 1492076631, 1492075158, 0, u'ul_rssi=-75;-60;-90;;'], [u'1014', u'10.172.71.11', u'wimax_dl_cinr', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_dl_intrf', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_dl_rssi', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_modulation_dl_fec', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_modulation_ul_fec', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_dl_utilization', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_frequency', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_ip', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_mac', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_sector_id', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_session_uptime', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_ul_utilization', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ss_uptime', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ul_cinr', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ul_intrf', 0, 0, 0, 1, u''], [u'1014', u'10.172.71.11', u'wimax_ul_rssi', 0, 0, 0, 1, u''], [u'1016', u'10.191.37.30', u'wimax_dl_cinr', 0, 1492076625, 1492075444, 1, u'dl_cinr=26;15;19;;'], [u'1016', u'10.191.37.30', u'wimax_dl_intrf', 0, 1492076625, 1492075444, 1, u'dl_intrf=Norm;;;;'], [u'1016', u'10.191.37.30', u'wimax_dl_rssi', 1, 1492076626, 1492075445, 1, u'dl_rssi=-60;-60;-90;;'], [u'1016', u'10.191.37.30', u'wimax_modulation_dl_fec', 0, 1492076626, 1492075445, 1, u'modulation_dl_fec=qam64-3/4;;;;'], [u'1016', u'10.191.37.30', u'wimax_modulation_ul_fec', 0, 1492076627, 1492075446, 1, u'modulation_ul_fec=qam16-1/2;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_dl_utilization', 0, 1492076627, 1487139750, 1, u'dl_utilization=0.04;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_frequency', 0, 1492076627, 1487139751, 1, u'frequency=3317.5;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_ip', 0, 1492076628, 1487139752, 1, u'ss_ip=10.191.37.30;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_mac', 0, 1492076628, 1487139753, 1, u'ss_mac=00:02:73:90:d4:a4;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_sector_id', 0, 1492076630, 1492075449, 1, u'ss_sector_id=00:0a:10:12:00:11;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_session_uptime', 0, 1492076630, 1487139755, 1, u'session_uptime=88511;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_ul_utilization', 0, 1492076630, 1487139756, 1, u'ul_utilization=0.06;;;;'], [u'1016', u'10.191.37.30', u'wimax_ss_uptime', 0, 1492076631, 1491679032, 1, u'uptime=88593;;;;'], [u'1016', u'10.191.37.30', u'wimax_ul_cinr', 0, 1492076631, 1492075451, 1, u'ul_cinr=20;19;15;;'], [u'1016', u'10.191.37.30', u'wimax_ul_intrf', 0, 1492076632, 1492075451, 1, u'ul_intrf=Norm;;;;'], [u'1016', u'10.191.37.30', u'wimax_ul_rssi', 1, 1492076632, 1492075452, 1, u'ul_rssi=-74;-60;-90;;'], [u'1018', u'10.172.71.59', u'wimax_dl_cinr', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_dl_intrf', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_dl_rssi', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_modulation_dl_fec', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_modulation_ul_fec', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_dl_utilization', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_frequency', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_ip', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_mac', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_sector_id', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_session_uptime', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_ul_utilization', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ss_uptime', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ul_cinr', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ul_intrf', 0, 0, 0, 1, u''], [u'1018', u'10.172.71.59', u'wimax_ul_rssi', 0, 0, 0, 1, u''], [u'1020', u'10.165.87.42', u'wimax_dl_cinr', 0, 1492076638, 1492075163, 1, u'dl_cinr=25;15;19;;'], [u'1020', u'10.165.87.42', u'wimax_dl_intrf', 0, 1492076638, 1492075163, 1, u'dl_intrf=Norm;;;;'], [u'1020', u'10.165.87.42', u'wimax_dl_rssi', 0, 1492076638, 1492075163, 1, u'dl_rssi=-59;-60;-90;;'], [u'1020', u'10.165.87.42', u'wimax_modulation_dl_fec', 0, 1492076639, 1492075164, 1, u'modulation_dl_fec=qam64-3/4;;;;'], [u'1020', u'10.165.87.42', u'wimax_modulation_ul_fec', 0, 1492076639, 1492075164, 1, u'modulation_ul_fec=qam16-3/4;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_dl_utilization', 0, 1492076640, 1487141815, 1, u'dl_utilization=0;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_frequency', 0, 1492076640, 1487141816, 1, u'frequency=3366;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_ip', 0, 1492076640, 1487141816, 1, u'ss_ip=10.165.87.42;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_mac', 0, 1492076641, 1487141817, 1, u'ss_mac=00:02:73:91:9f:b3;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_sector_id', 0, 1492076642, 1492075167, 1, u'ss_sector_id=00:0b:10:05:41:33;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_session_uptime', 0, 1492076643, 1491972783, 1, u'session_uptime=17742;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_ul_utilization', 0, 1492076643, 1487141820, 1, u'ul_utilization=0;;;;'], [u'1020', u'10.165.87.42', u'wimax_ss_uptime', 0, 1492076643, 1488165010, 1, u'uptime=17724;;;;'], [u'1020', u'10.165.87.42', u'wimax_ul_cinr', 0, 1492076644, 1492075169, 1, u'ul_cinr=22;19;15;;'], [u'1020', u'10.165.87.42', u'wimax_ul_intrf', 0, 1492076644, 1492075170, 1, u'ul_intrf=Norm;;;;'], [u'1020', u'10.165.87.42', u'wimax_ul_rssi', 1, 1492076645, 1492075170, 1, u'ul_rssi=-76;-60;-90;;'], [u'1022', u'10.175.236.32', u'wimax_dl_cinr', 0, 1492076633, 1492075453, 1, u'dl_cinr=23;15;19;;'], [u'1022', u'10.175.236.32', u'wimax_dl_intrf', 0, 1492076634, 1492075454, 1, u'dl_intrf=Norm;;;;'], [u'1022', u'10.175.236.32', u'wimax_dl_rssi', 0, 1492076634, 1492075454, 1, u'dl_rssi=-55;-60;-90;;'], [u'1022', u'10.175.236.32', u'wimax_modulation_dl_fec', 0, 1492076635, 1492075455, 1, u'modulation_dl_fec=qam64-2/3;;;;'], [u'1022', u'10.175.236.32', u'wimax_modulation_ul_fec', 0, 1492076635, 1492075750, 1, u'modulation_ul_fec=qam16-3/4;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_dl_utilization', 0, 1492076635, 1487139751, 1, u'dl_utilization=;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_frequency', 0, 1492076636, 1487139752, 1, u'frequency=3317.5;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_ip', 0, 1492076636, 1487139752, 1, u'ss_ip=10.175.236.32;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_mac', 0, 1492076637, 1487139753, 1, u'ss_mac=00:02:73:91:82:03;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_sector_id', 0, 1492076638, 1492075753, 1, u'ss_sector_id=00:0a:10:12:00:11;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_session_uptime', 0, 1492076639, 1487139755, 1, u'session_uptime=;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_ul_utilization', 0, 1492076639, 1487139756, 1, u'ul_utilization=;;;;'], [u'1022', u'10.175.236.32', u'wimax_ss_uptime', 0, 1492076640, 1488944490, 1, u'uptime=227;;;;'], [u'1022', u'10.175.236.32', u'wimax_ul_cinr', 0, 1492076640, 1492075755, 1, u'ul_cinr=23;19;15;;'], [u'1022', u'10.175.236.32', u'wimax_ul_intrf', 0, 1492076641, 1492075756, 1, u'ul_intrf=Norm;;;;'], [u'1022', u'10.175.236.32', u'wimax_ul_rssi', 1, 1492076641, 1492075756, 1, u'ul_rssi=-74;-60;-90;;'], [u'1024', u'10.165.87.34', u'wimax_dl_cinr', 0, 1492076623, 1492075147, 1, u'dl_cinr=22;15;19;;'], [u'1024', u'10.165.87.34', u'wimax_dl_intrf', 0, 1492076624, 1492075148, 1, u'dl_intrf=Norm;;;;'], [u'1024', u'10.165.87.34', u'wimax_dl_rssi', 1, 1492076624, 1492075148, 1, u'dl_rssi=-73;-60;-90;;'], [u'1024', u'10.165.87.34', u'wimax_modulation_dl_fec', 0, 1492076625, 1492075149, 1, u'modulation_dl_fec=qam64-2/3;;;;'], [u'1024', u'10.165.87.34', u'wimax_modulation_ul_fec', 0, 1492076625, 1492075149, 1, u'modulation_ul_fec=qam16-1/2;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_dl_utilization', 0, 1492076626, 1487139750, 1, u'dl_utilization=0.01;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_frequency', 0, 1492076626, 1487139751, 1, u'frequency=3366;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_ip', 0, 1492076627, 1487139752, 1, u'ss_ip=10.165.87.34;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_mac', 0, 1492076627, 1487139752, 1, u'ss_mac=00:02:73:91:87:f9;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_sector_id', 0, 1492076629, 1492075153, 1, u'ss_sector_id=00:0b:10:05:41:33;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_session_uptime', 0, 1492076630, 1487139754, 1, u'session_uptime=159381;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_ul_utilization', 0, 1492076630, 1487139755, 1, u'ul_utilization=0.01;;;;'], [u'1024', u'10.165.87.34', u'wimax_ss_uptime', 0, 1492076631, 1491543022, 1, u'uptime=159353;;;;'], [u'1024', u'10.165.87.34', u'wimax_ul_cinr', 0, 1492076631, 1492076039, 1, u'ul_cinr=21;19;15;;'], [u'1024', u'10.165.87.34', u'wimax_ul_intrf', 0, 1492076632, 1492075155, 1, u'ul_intrf=Norm;;;;'], [u'1024', u'10.165.87.34', u'wimax_ul_rssi', 1, 1492076632, 1492075155, 1, u'ul_rssi=-80;-60;-90;;'], [u'1026', u'10.191.26.53', u'wimax_dl_cinr', 0, 1488620246, 1487838433, 1, u'dl_cinr=27;15;19;;'], [u'1026', u'10.191.26.53', u'wimax_dl_intrf', 0, 1488620246, 1487838433, 1, u'dl_intrf=Norm;;;;'], [u'1026', u'10.191.26.53', u'wimax_dl_rssi', 1, 1488620246, 1488594281, 1, u'dl_rssi=-60;-60;-90;;'], [u'1026', u'10.191.26.53', u'wimax_modulation_dl_fec', 0, 1488620247, 1487838435, 1, u'modulation_dl_fec=qam64-3/4;;;;']]
		group_iter = [iter(service_data)]*int(device_slot)
		device_slot_data = list(([e for e in t if e !=None] for t in itertools.izip_longest(*group_iter)))
		print len(device_slot_data)
		i=1;		
		for slot in device_slot_data:
			redis_hook_4.rpush("sv_"+site_name+"_slot_"+str(i),slot)
			i+=1

	for machine in config:
		for site in machine.get('sites'):
			PythonOperator(
	   		task_id="Service_extract_%s"%(site.get('name')),
	  		provide_context=True,
	 		python_callable=extract_and_distribute,
			dag=dag_subdag
			)	
	return dag_subdag
